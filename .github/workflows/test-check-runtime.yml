# TEMPORARY: delete this file before merging.
# Used to validate check-runtime on this PR.
name: "Test: check-runtime"

on:
  pull_request:

jobs:
  runtime-matrix:
    runs-on: ubuntu-latest
    outputs:
      runtime: ${{ steps.runtime.outputs.runtime }}
    steps:
      - uses: actions/checkout@v4
      - id: runtime
        run: |
          TASKS=$(echo $(cat .github/workflows/runtimes-matrix.json) | sed 's/ //g' )
          echo "runtime=$TASKS" >> $GITHUB_OUTPUT

  build-runtimes:
    needs: [ runtime-matrix ]
    runs-on: self-hosted
    strategy:
      matrix:
        runtime: ${{ fromJSON(needs.runtime-matrix.outputs.runtime) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set rust version via common env file
        run: cat .github/env >> $GITHUB_ENV

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          targets: "wasm32v1-none"
          components: "rust-src"
          toolchain: "${{env.RUST_STABLE_VERSION}}"

      - name: Fetch cache
        uses: Swatinem/rust-cache@f0deed1e0edfc6a9be95417288c0e1099b1eeec3 # v2.7.7
        with:
          shared-key: "fellowship-cache-build-runtimes-test"
          save-if: false

      - name: Build runtime ${{ matrix.runtime.name }}
        run: |
          PACKAGE_NAME=${{ matrix.runtime.package }}
          RUNTIME_BLOB_NAME=$(echo $PACKAGE_NAME | sed 's/-/_/g').compact.compressed.wasm
          RUNTIME_BLOB_PATH=./target/production/wbuild/$PACKAGE_NAME/$RUNTIME_BLOB_NAME

          FEATURES=""
          if cargo metadata --format-version=1 | jq '.packages[] | select(.name=="${{ matrix.runtime.package }}") | .features' | grep metadata-hash; then
            FEATURES="metadata-hash"
          fi
          if [ -n "${{ matrix.runtime.build_extra_features }}" ]; then
            if [ -z "$FEATURES" ]; then
              FEATURES="${{ matrix.runtime.build_extra_features }}"
            else
              FEATURES="$FEATURES,${{ matrix.runtime.build_extra_features }}"
            fi
          fi
          if [ -n "$FEATURES" ]; then
            FEATURES="--features=$FEATURES"
          fi

          cargo build --profile production -p ${{ matrix.runtime.package }} $FEATURES -q --locked
          echo "RUNTIME_BLOB_PATH=$RUNTIME_BLOB_PATH" >> $GITHUB_ENV

      - name: Upload ${{ matrix.runtime.name }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.runtime.name }}
          path: ${{ env.RUNTIME_BLOB_PATH }}

  check-runtimes:
    needs: [ runtime-matrix, build-runtimes ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        runtime: ${{ fromJSON(needs.runtime-matrix.outputs.runtime) }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'node'

      - name: Download ${{ matrix.runtime.name }} WASM artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ${{ matrix.runtime.name }}

      - name: Check runtime
        env:
          RUNTIME_NAME: ${{ matrix.runtime.name }}
          URIS_JSON: ${{ toJSON(matrix.runtime.uris) }}
        run: |
          if [ "$URIS_JSON" = "null" ] || [ -z "$URIS_JSON" ]; then
            echo "::notice::Skipping $RUNTIME_NAME — no URIs configured"
            exit 0
          fi

          WASM=$(find . -name '*.compact.compressed.wasm' -print -quit)
          if [ -z "$WASM" ]; then
            echo "::error::WASM artifact missing for $RUNTIME_NAME — build may have failed"
            exit 1
          fi
          echo "Found WASM: $WASM"

          readarray -t URIS < <(echo "$URIS_JSON" | jq -r '.[]')
          for URI in "${URIS[@]}"; do
            if ! node -e "
              const ws = new WebSocket('$URI');
              ws.onopen = () => { ws.close(); process.exit(0) };
              ws.onerror = () => process.exit(1);
              setTimeout(() => process.exit(1), 10000);
            "; then
              echo "RPC $URI is unreachable, trying next..."
              continue
            fi
            echo "RPC $URI is up, running check..."
            npx @polkadot-api/check-runtime@latest problems "$URI" --wasm "$WASM"
            exit $?
          done

          echo "::error::No reachable RPC for $RUNTIME_NAME"
          exit 1
